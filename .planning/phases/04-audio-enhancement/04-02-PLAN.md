---
phase: 04-audio-enhancement
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/hooks/useAudioControls.ts
  - src/components/AudioControls.tsx
autonomous: true

must_haves:
  truths:
    - "Volume changes use Web Audio API GainNode for smooth transitions (no clicking)"
    - "Playback rate changes apply to audio element in real-time"
    - "Mute toggle silences audio via volume smoothing, not direct muting"
  artifacts:
    - path: "src/hooks/useAudioControls.ts"
      provides: "Web Audio API integration for smooth audio controls"
      exports: ["useAudioControls"]
    - path: "src/components/AudioControls.tsx"
      provides: "UI component for audio controls (volume, speed, mute, enable)"
      exports: ["AudioControls"]
  key_links:
    - from: "src/hooks/useAudioControls.ts"
      to: "src/store/audioStore.ts"
      via: "useAudioStore hook import"
      pattern: "from.*audioStore"
    - from: "src/components/AudioControls.tsx"
      to: "src/hooks/useAudioControls.ts"
      via: "useAudioControls hook import"
      pattern: "from.*useAudioControls"
    - from: "src/components/AudioControls.tsx"
      to: "src/store/audioStore.ts"
      via: "useAudioStore hook import"
      pattern: "from.*audioStore"
---

<objective>
Create audio controls implementation with Web Audio API GainNode for smooth volume transitions, and UI component for user to adjust volume, playback speed, and mute toggles.

Purpose: Provide user-facing audio controls that prevent audio clicking and enable real-time adjustment of audio playback.

Output: useAudioControls hook with GainNode smoothing, AudioControls component with volume/speed/mute/enable UI.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-audio-enhancement/04-RESEARCH.md
@.planning/phases/04-audio-enhancement/04-01-PLAN.md

# Existing codebase
@src/store/audioStore.ts
@src/hooks/useTTS.ts
@src/api/tts.ts

# Prior phase summaries (for patterns)
@.planning/phases/04-audio-enhancement/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAudioControls hook with Web Audio API GainNode</name>
  <files>src/hooks/useAudioControls.ts</files>
  <action>
Create `src/hooks/useAudioControls.ts` with the following:

1. Import useRef, useEffect, useCallback from react
2. Import useAudioStore from store/audioStore
3. Define hook signature: useAudioControls(audioRef: React.RefObject<HTMLAudioElement>)
4. Create audioContextRef and gainNodeRef as refs inside hook
5. Initialize AudioContext on first user interaction:
   - Create AudioContextClass = window.AudioContext || window.webkitAudioContext
   - Lazy initialize when audio plays (not on mount)
   - Resume if suspended (browser autoplay policy)
6. Connect audio graph: Source â†’ Gain â†’ Destination using createMediaElementSource
7. Implement setVolume function using GainNode.setTargetAtTime:
   - Parameters: target value, audioContext.currentTime, timeConstant (0.02 for 20ms smoothing)
   - This prevents audio clicking
8. Implement setPlaybackRate function that directly assigns to audio.playbackRate
9. Implement cleanup on unmount: disconnect nodes, close context
10. Return { setVolume, setPlaybackRate, initializeAudio }

CRITICAL: Use GainNode.setTargetAtTime for volume changes to prevent clicking. Do NOT use direct audio.volume assignment.

DO NOT:
- Initialize AudioContext on mount (violates autoplay policy)
- Store audio element in hook state (passed as ref)
- Create multiple GainNodes (one per hook instance)

Reference Pattern 2 from 04-RESEARCH.md for Web Audio API implementation details.
  </action>
  <verify>
```bash
npm run build
```
Build succeeds without TypeScript errors.
  </verify>
  <done>
useAudioControls hook created with AudioContext lazy initialization, GainNode smoothing for volume changes, setVolume/setPlaybackRate/initializeAudio functions returned.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AudioControls component with volume/speed/mute UI</name>
  <files>src/components/AudioControls.tsx</files>
  <action>
Create `src/components/AudioControls.tsx` with the following:

1. Import useRef from react
2. Import useAudioStore from store/audioStore
3. Import useAudioControls from hooks/useAudioControls
4. Create audioRef as useRef<HTMLAudioElement>(null) for hidden audio element
5. Get state from useAudioStore: volume, playbackRate, isMuted, isEnabled, setVolume, setPlaybackRate, toggleMute, toggleEnabled
6. Get setVolume as smoothVolume from useAudioControls(audioRef)
7. Implement useEffect to apply volume changes:
   - When volume or isMuted changes, call smoothVolume with effective volume (0 if muted, else volume)
   - When isEnabled changes, handle TTS enable/disable in streaming components
8. Implement useEffect to apply playback rate:
   - When playbackRate changes, set audioRef.current?.playbackRate = playbackRate
9. Render UI with Tailwind CSS:
   - Container div with flex layout, gap-4, p-4, bg-gray-100 rounded-lg
   - Volume slider: input type="range" min="0" max="2" step="0.01", displays percentage
   - Playback speed slider: input type="range" min="0.5" max="2.5" step="0.1", displays "x" multiplier
   - Mute toggle button: shows ðŸ”Š/ðŸ”‡ emoji, styled with conditional bg
   - Enable toggle button: shows "Audio On/Off", controls global TTS
   - Hidden audio element: <audio ref={audioRef} className="hidden" />
10. Add appropriate aria-labels for accessibility

DO NOT:
- Connect to streaming TTS directly (integration is in next plan)
- Persist settings to localStorage (keep runtime-only)
- Add advanced audio effects (reverb, equalizer, etc.)

Reference "Complete Audio Control Component" example from 04-RESEARCH.md for implementation patterns.
  </action>
  <verify>
```bash
npm run build
```
Build succeeds without TypeScript errors.
  </verify>
  <done>
AudioControls component created with volume slider (0-200%), playback speed slider (0.5x-2.5x), mute toggle, enable toggle, hidden audio element, useAudioControls integration for smooth volume.
  </done>
</task>

</tasks>

<verification>
- useAudioControls compiles with GainNode smoothing implementation
- AudioControls component renders with all controls
- Volume changes use setTargetAtTime (not direct assignment)
- Hidden audio element exists for audio graph connection
- Accessibility labels present on all interactive elements
</verification>

<success_criteria>
Build succeeds, AudioControls component renders all controls (volume, speed, mute, enable), useAudioControls provides smooth volume transitions via GainNode.
</success_criteria>

<output>
After completion, create `.planning/phases/04-audio-enhancement/04-02-SUMMARY.md`
</output>
